/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */
document.addEventListener('DOMContentLoaded', () => {
    // Configuração de marcador markdown
    marked.setOptions({
        sanitize: false,
        breaks: true,
        gfm: true
    });

    // Classe para comunicação com o n8n
    class N8NService {
        constructor() {
            this.webhookUrl = localStorage.getItem('N8N_WEBHOOK_URL') || '';
        }

        setWebhookUrl(url) {
            this.webhookUrl = url;
            localStorage.setItem('N8N_WEBHOOK_URL', url);
        }

        async processSession(audioBlob) {
            if (!this.webhookUrl) {
                throw new Error('URL do webhook do n8n não configurada. Por favor, configure nas configurações.');
            }

            try {
                const base64Audio = await this.blobToBase64(audioBlob);
                const response = await fetch(this.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        audioBase64: base64Audio,
                        mimeType: audioBlob.type,
                        patientName: document.querySelector('.patient-name-display')?.textContent || 'Paciente'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro ao processar sessão: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }

                return {
                    transcription: result.transcription || 'Transcrição não disponível',
                    polishedNote: result.polishedNote || 'Registro não formatado'
                };
            } catch (error) {
                console.error('Erro no processamento com n8n:', error);
                throw error;
            }
        }

        async generateTimelineSummary(content) {
            if (!this.webhookUrl) {
                return "URL do webhook não configurada";
            }

            try {
                const response = await fetch(this.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'generateSummary',
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro ao gerar resumo: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                return result.summary || "Não foi possível gerar o resumo.";
            } catch (error) {
                console.error('Erro ao gerar resumo com n8n:', error);
                return "Erro ao gerar resumo.";
            }
        }

        blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
    }

    // Classe principal do aplicativo
    class VoiceNotesApp {
        constructor() {
            this.n8nService = new N8NService();
            this.audioChunks = [];
            this.isRecording = false;
            this.currentNote = null;
            this.currentPatient = null;
            this.stream = null;
            this.mediaRecorder = null;
            this.audioContext = null;
            this.analyserNode = null;
            this.waveformDataArray = null;
            this.waveformDrawingId = null;
            this.timerIntervalId = null;
            this.recordingStartTime = 0;
            this.notes = [];
            this.patients = [];
            
            // Elementos DOM
            this.recordButton = document.getElementById('recordButton');
            this.recordingStatus = document.getElementById('recordingStatus');
            this.rawTranscription = document.getElementById('rawTranscription');
            this.polishedNote = document.getElementById('polishedNote');
            this.newNoteSidebarButton = document.getElementById('newNoteSidebarButton');
            this.themeToggleButton = document.getElementById('themeToggleButton');
            this.toggleSidebarButton = document.getElementById('toggleSidebarButton');
            this.sidebarOverlay = document.getElementById('sidebarOverlay');
            this.notesList = document.getElementById('notesList');
            this.editorTitle = document.querySelector('.editor-title');
            this.liveRecordingTitle = document.getElementById('liveRecordingTitle');
            this.liveWaveformCanvas = document.getElementById('liveWaveformCanvas');
            this.liveRecordingTimerDisplay = document.getElementById('liveRecordingTimerDisplay');
            this.statusIndicatorDiv = document.querySelector('.status-indicator');
            
            // Patient View elements
            this.patientsView = document.getElementById('patientsView');
            this.patientDetailView = document.getElementById('patientDetailView');
            this.patientInfoView = document.getElementById('patientInfoView');
            this.addPatientBtn = document.getElementById('addPatientBtn');
            this.patientsGrid = document.getElementById('patientsGrid');
            this.addPatientModal = document.getElementById('addPatientModal');
            this.patientNameInput = document.getElementById('patientNameInput');
            this.savePatientBtn = document.getElementById('savePatientBtn');
            this.cancelAddPatientBtn = document.getElementById('cancelAddPatientBtn');
            this.backToPatientsBtn = document.getElementById('backToPatientsBtn');
            this.patientNameDisplay = document.getElementById('patientNameDisplay');
            this.editPatientNameBtn = document.getElementById('editPatientNameBtn');
            this.showPatientInfoBtn = document.getElementById('showPatientInfoBtn');
            
            // Patient Info elements
            this.backToDetailBtn = document.getElementById('backToDetailBtn');
            this.patientInfoNameDisplay = document.getElementById('patientInfoNameDisplay');
            this.patientWhatsappInput = document.getElementById('patientWhatsappInput');
            this.patientEmailInput = document.getElementById('patientEmailInput');
            this.savePatientInfoBtn = document.getElementById('savePatientInfoBtn');
            this.patientTagsInput = document.getElementById('patientTagsInput');
            this.addTagBtn = document.getElementById('addTagBtn');
            this.patientTagsContainer = document.getElementById('patientTagsContainer');
            this.patientTimelineContainer = document.getElementById('patientTimelineContainer');
            
            // Modais
            this.confirmationModal = document.getElementById('confirmationModal');
            this.confirmationModalMessage = document.getElementById('confirmationModalMessage');
            this.confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            this.cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            this.settingsModal = document.getElementById('settingsModal');
            this.n8nWebhookInput = document.getElementById('n8nWebhookInput');
            this.saveSettingsBtn = document.getElementById('saveSettingsBtn');
            
            // Canvas para visualização de áudio
            if (this.liveWaveformCanvas) {
                this.liveWaveformCtx = this.liveWaveformCanvas.getContext('2d');
            }
            
            // Inicialização
            this.checkWebhookConfiguration();
            this.bindEventListeners();
            this.initTheme();
            this.loadPatientsFromStorage();
            this.loadNotesFromStorage();
            this.renderPatientsGrid();
            this.showView('patientsView');
        }

        checkWebhookConfiguration() {
            const webhookUrl = localStorage.getItem('N8N_WEBHOOK_URL');
            if (!webhookUrl) {
                setTimeout(() => {
                    this.showSettingsModal(true, 'Bem-vindo! Para usar este aplicativo, você precisa configurar a URL do webhook do n8n.');
                }, 500);
            }
        }

        bindEventListeners() {
            // Configurações
            document.getElementById('openSettingsBtn').addEventListener('click', () => this.showSettingsModal(true));
            document.getElementById('closeSettingsModalBtn').addEventListener('click', () => this.showSettingsModal(false));
            this.cancelAddPatientBtn.addEventListener('click', () => this.showAddPatientModal(false));
            this.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
            
            // Navegação entre views
            this.backToPatientsBtn.addEventListener('click', () => this.showPatientsView());
            this.showPatientInfoBtn.addEventListener('click', () => this.showPatientInfoView());
            this.backToDetailBtn.addEventListener('click', () => this.showPatientDetailView(this.currentPatient?.id));
            
            // Gestão de pacientes
            this.addPatientBtn.addEventListener('click', () => this.showAddPatientModal(true));
            this.patientsGrid.addEventListener('click', (e) => {
                const target = e.target;
                const patientCard = target.closest('.patient-card');
                if (!patientCard) return;
                const patientId = patientCard.getAttribute('data-patient-id');
                if (!patientId) return;
                if (target.closest('.delete-patient-button')) {
                    this.deletePatient(patientId);
                } else {
                    this.showPatientDetailView(patientId);
                }
            });
            
            // Informações do paciente
            this.savePatientInfoBtn.addEventListener('click', () => this.savePatientInfo());
            this.addTagBtn.addEventListener('click', () => this.addPatientTag());
            this.patientTagsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addPatientTag();
                }
            });
            this.patientTagsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const deleteButton = target.closest('.delete-tag-btn');
                if (deleteButton) {
                    const tagElement = deleteButton.parentElement;
                    const tag = tagElement.textContent?.trim().replace('×', '').trim() || '';
                    if (tag) this.removePatientTag(tag);
                }
            });
            
            // Edição de nome do paciente
            this.editPatientNameBtn.addEventListener('click', () => this.toggleNameEditing());
            this.patientInfoNameDisplay.addEventListener('keydown', (e) => {
                if (!this.isEditingPatientName) return;
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.toggleNameEditing();
                } else if (e.key === 'Escape') {
                    this.patientInfoNameDisplay.textContent = this.originalPatientName;
                    this.toggleNameEditing();
                }
            });
            
            // Modal de confirmação
            this.confirmDeleteBtn.addEventListener('click', () => this.handleConfirm());
            this.cancelDeleteBtn.addEventListener('click', () => this.hideConfirmationModal());
            this.confirmationModal.addEventListener('click', (e) => {
                if (e.target === this.confirmationModal) {
                    this.hideConfirmationModal();
                }
            });
            
            // Gestão de notas
            this.recordButton.addEventListener('click', () => this.toggleRecording());
            this.newNoteSidebarButton.addEventListener('click', () => this.createNewNote());
            this.themeToggleButton.addEventListener('click', () => this.toggleTheme());
            this.toggleSidebarButton.addEventListener('click', () => this.toggleSidebar());
            this.sidebarOverlay.addEventListener('click', () => this.toggleSidebar());
            this.notesList.addEventListener('click', (e) => {
                const target = e.target;
                const noteItem = target.closest('.note-item');
                if (!noteItem) return;
                const noteId = noteItem.getAttribute('data-note-id');
                if (!noteId) return;
                if (target.closest('.delete-note-button')) {
                    this.deleteNote(noteId);
                } else {
                    this.loadNote(noteId);
                }
            });
            
            // Salvamento automático
            this.editorTitle.addEventListener('input', () => this.saveCurrentNote());
            this.rawTranscription.addEventListener('input', () => this.saveCurrentNote());
            this.polishedNote.addEventListener('input', () => this.saveCurrentNote());
            
            // Redimensionamento da janela
            window.addEventListener('resize', this.handleResize.bind(this));
        }

        showSettingsModal(show, message = '') {
            if (show) {
                this.n8nWebhookInput.value = localStorage.getItem('N8N_WEBHOOK_URL') || '';
                if (message) {
                    const messageEl = document.getElementById('settingsMessage');
                    if (messageEl) {
                        messageEl.textContent = message;
                        messageEl.style.display = 'block';
                    }
                }
                this.settingsModal.classList.remove('hidden');
                setTimeout(() => this.n8nWebhookInput.focus(), 50);
            } else {
                this.settingsModal.classList.add('hidden');
                const messageEl = document.getElementById('settingsMessage');
                if (messageEl) {
                    messageEl.style.display = 'none';
                }
            }
        }

        saveSettings() {
            const webhookUrl = this.n8nWebhookInput.value.trim();
            if (!webhookUrl) {
                alert('Por favor, insira uma URL válida do webhook do n8n.');
                return;
            }
            
            try {
                new URL(webhookUrl);
            } catch (e) {
                alert('URL inválida. Por favor, verifique o formato.');
                return;
            }
            
            this.n8nService.setWebhookUrl(webhookUrl);
            this.showSettingsModal(false);
            alert('Configurações salvas com sucesso!');
        }

        showView(viewId) {
            [this.patientsView, this.patientDetailView, this.patientInfoView].forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        showPatientsView() {
            this.showView('patientsView');
            this.currentPatient = null;
            this.currentNote = null;
            document.body.classList.remove('sidebar-open');
        }

        showPatientDetailView(patientId) {
            const patient = this.patients.find(p => p.id === patientId);
            if (!patient) return;
            this.currentPatient = patient;
            this.patientNameDisplay.textContent = this.currentPatient.name;
            this.showView('patientDetailView');
            const patientNotes = this.notes.filter(n => n.patientId === patientId);
            if (patientNotes.length > 0) {
                this.loadNote(patientNotes[0].id);
            } else {
                this.createNewNote();
            }
            this.renderNotesList();
        }

        async showPatientInfoView() {
            if (!this.currentPatient) return;
            if (this.isEditingPatientName) {
                this.toggleNameEditing();
            }
            this.patientInfoNameDisplay.textContent = this.currentPatient.name;
            this.patientWhatsappInput.value = this.currentPatient.whatsapp || '';
            this.patientEmailInput.value = this.currentPatient.email || '';
            this.renderPatientTags();
            this.showView('patientInfoView');
            
            // Gerar resumos da linha do tempo
            this.patientTimelineContainer.innerHTML = `<div class="timeline-loading">Gerando linha do tempo...</div>`;
            const patientNotes = this.notes.filter(n => n.patientId === this.currentPatient.id);
            let summaryGenerated = false;
            for (const note of patientNotes) {
                const hasContent = note.polishedNote || note.rawTranscription;
                if (hasContent && !note.timelineSummary) {
                    await this.generateTimelineSummary(note);
                    summaryGenerated = true;
                }
            }
            if (summaryGenerated) {
                this.saveNotesToStorage();
            }
            this.renderPatientTimeline();
        }

        toggleNameEditing() {
            if (!this.currentPatient) return;
            if (!this.isEditingPatientName) {
                // Iniciar edição
                this.isEditingPatientName = true;
                this.originalPatientName = this.currentPatient.name;
                this.patientInfoNameDisplay.contentEditable = 'true';
                this.patientInfoNameDisplay.classList.add('is-editing');
                this.editPatientNameBtn.innerHTML = '<i class="fas fa-check"></i>';
                this.editPatientNameBtn.setAttribute('title', 'Salvar Nome');
                this.patientInfoNameDisplay.focus();
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(this.patientInfoNameDisplay);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // Salvar edição
                const newName = this.patientInfoNameDisplay.textContent?.trim();
                this.patientInfoNameDisplay.contentEditable = 'false';
                this.patientInfoNameDisplay.classList.remove('is-editing');
                this.editPatientNameBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                this.editPatientNameBtn.setAttribute('title', 'Editar Nome');
                this.isEditingPatientName = false;
                
                if (!newName) {
                    alert('O nome do paciente não pode estar vazio.');
                    this.patientInfoNameDisplay.textContent = this.originalPatientName;
                    return;
                }
                
                if (newName === this.originalPatientName) {
                    return;
                }
                
                this.currentPatient.name = newName;
                const patientIndex = this.patients.findIndex(p => p.id === this.currentPatient.id);
                if (patientIndex !== -1) {
                    this.patients[patientIndex].name = newName;
                }
                this.savePatientsToStorage();
                this.patientNameDisplay.textContent = newName;
                this.renderPatientsGrid();
            }
        }

        async generateTimelineSummary(note) {
            try {
                const contentToSummarize = note.polishedNote ?
                    new DOMParser().parseFromString(note.polishedNote, 'text/html').body.textContent :
                    note.rawTranscription;
                    
                if (!contentToSummarize || contentToSummarize.trim().length < 20) {
                    note.timelineSummary = "Sessão curta ou sem conteúdo para resumir.";
                    return;
                }
                
                note.timelineSummary = await this.n8nService.generateTimelineSummary(contentToSummarize);
            } catch (error) {
                console.error(`Error generating summary for note ${note.id}:`, error);
                note.timelineSummary = "Erro ao gerar resumo.";
            }
        }

        renderPatientTimeline() {
            this.patientTimelineContainer.innerHTML = '';
            if (!this.currentPatient) return;
            
            const patientNotesWithSummary = this.notes
                .filter(n => n.patientId === this.currentPatient.id && n.timelineSummary)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (patientNotesWithSummary.length === 0) {
                this.patientTimelineContainer.innerHTML = `<div class="timeline-loading">Nenhum registro de sessão encontrado para gerar a linha do tempo.</div>`;
                return;
            }
            
            patientNotesWithSummary.forEach(note => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                const date = new Date(note.timestamp).toLocaleDateString('pt-BR', {
                    day: '2-digit', month: 'long', year: 'numeric'
                });
                item.innerHTML = `
                    <div class="timeline-date">${date}</div>
                    <p class="timeline-summary">${note.timelineSummary}</p>
                `;
                this.patientTimelineContainer.appendChild(item);
            });
        }

        savePatientInfo() {
            if (!this.currentPatient) return;
            const patientIndex = this.patients.findIndex(p => p.id === this.currentPatient.id);
            if (patientIndex === -1) return;
            
            this.currentPatient.whatsapp = this.patientWhatsappInput.value.trim();
            this.currentPatient.email = this.patientEmailInput.value.trim();
            this.patients[patientIndex] = this.currentPatient;
            this.savePatientsToStorage();
            
            // Feedback visual
            this.savePatientInfoBtn.textContent = 'Salvo!';
            this.savePatientInfoBtn.style.backgroundColor = 'var(--color-success)';
            setTimeout(() => {
                this.savePatientInfoBtn.textContent = 'Salvar Informações';
                this.savePatientInfoBtn.style.backgroundColor = '';
            }, 2000);
        }

        addPatientTag() {
            if (!this.currentPatient) return;
            const tag = this.patientTagsInput.value.trim();
            if (!tag) return;
            
            if (!this.currentPatient.tags) {
                this.currentPatient.tags = [];
            }
            
            if (!this.currentPatient.tags.includes(tag)) {
                this.currentPatient.tags.push(tag);
                this.savePatientsToStorage();
                this.renderPatientTags();
            }
            
            this.patientTagsInput.value = '';
            this.patientTagsInput.focus();
        }

        removePatientTag(tagToRemove) {
            if (!this.currentPatient || !this.currentPatient.tags) return;
            this.currentPatient.tags = this.currentPatient.tags.filter(tag => tag !== tagToRemove);
            this.savePatientsToStorage();
            this.renderPatientTags();
        }

        renderPatientTags() {
            this.patientTagsContainer.innerHTML = '';
            if (!this.currentPatient || !this.currentPatient.tags) return;
            
            this.currentPatient.tags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag-item';
                tagEl.innerHTML = `${tag} <button class="delete-tag-btn"><i class="fas fa-times"></i></button>`;
                this.patientTagsContainer.appendChild(tagEl);
            });
        }

        showAddPatientModal(show) {
            if (show) {
                this.patientNameInput.value = '';
                this.addPatientModal.classList.remove('hidden');
                setTimeout(() => this.patientNameInput.focus(), 50);
            } else {
                this.addPatientModal.classList.add('hidden');
            }
        }

        showConfirmationModal(message, onConfirm) {
            this.confirmationModalMessage.textContent = message;
            this.confirmAction = onConfirm;
            this.confirmationModal.classList.remove('hidden');
        }

        hideConfirmationModal() {
            this.confirmationModal.classList.add('hidden');
            this.confirmAction = null;
        }

        handleConfirm() {
            if (this.confirmAction) {
                this.confirmAction();
            }
            this.hideConfirmationModal();
        }

        loadPatientsFromStorage() {
            const patientsJson = localStorage.getItem('psychotherapy_patients');
            if (patientsJson) {
                this.patients = JSON.parse(patientsJson);
                this.patients.sort((a, b) => b.timestamp - a.timestamp);
            } else {
                this.patients = [];
            }
        }

        savePatientsToStorage() {
            localStorage.setItem('psychotherapy_patients', JSON.stringify(this.patients));
        }

        renderPatientsGrid() {
            this.patientsGrid.innerHTML = '';
            if (this.patients.length === 0) {
                this.patientsGrid.innerHTML = '<p class="no-patients-message">Nenhum paciente cadastrado. Clique em "Adicionar Paciente" para começar.</p>';
                return;
            }
            
            this.patients.forEach(patient => {
                const card = document.createElement('div');
                card.className = 'patient-card';
                card.setAttribute('data-patient-id', patient.id);
                const date = new Date(patient.timestamp).toLocaleDateString('pt-BR', {
                    day: '2-digit', month: 'long', year: 'numeric'
                });
                card.innerHTML = `
                    <div class="patient-card-name">${patient.name}</div>
                    <div class="patient-card-date">Adicionado em: ${date}</div>
                    <button class="delete-patient-button" title="Apagar Paciente"><i class="fas fa-trash"></i></button>
                `;
                this.patientsGrid.appendChild(card);
            });
        }

        saveNewPatient() {
            const name = this.patientNameInput.value.trim();
            if (!name) {
                alert('Por favor, insira um nome para o paciente.');
                return;
            }
            
            const newPatient = {
                id: `patient_${Date.now()}`,
                name: name,
                timestamp: Date.now()
            };
            
            this.patients.unshift(newPatient);
            this.savePatientsToStorage();
            this.renderPatientsGrid();
            this.showAddPatientModal(false);
        }

        deletePatient(patientId) {
            const patient = this.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const message = `Tem certeza que deseja apagar "${patient.name}"? Todos os registros de sessão deste paciente também serão apagados permanentemente. Esta ação não pode ser desfeita.`;
            this.showConfirmationModal(message, () => {
                this.patients = this.patients.filter(p => p.id !== patientId);
                this.notes = this.notes.filter(n => n.patientId !== patientId);
                this.savePatientsToStorage();
                this.saveNotesToStorage();
                this.renderPatientsGrid();
            });
        }

        toggleSidebar() {
            const isOpen = document.body.classList.toggle('sidebar-open');
            if (isOpen) {
                this.toggleSidebarButton.setAttribute('title', 'Fechar Sessões');
                this.toggleSidebarButton.querySelector('i').className = 'fas fa-times';
            } else {
                this.toggleSidebarButton.setAttribute('title', 'Mostrar/Ocultar Sessões');
                this.toggleSidebarButton.querySelector('i').className = 'fas fa-history';
            }
        }

        loadNotesFromStorage() {
            const notesJson = localStorage.getItem('psychotherapy_notes');
            if (notesJson) {
                this.notes = JSON.parse(notesJson);
            } else {
                this.notes = [];
            }
        }

        saveNotesToStorage() {
            localStorage.setItem('psychotherapy_notes', JSON.stringify(this.notes));
        }

        renderNotesList() {
            this.notesList.innerHTML = '';
            if (!this.currentPatient) return;
            
            const patientNotes = this.notes
                .filter(n => n.patientId === this.currentPatient.id)
                .sort((a, b) => b.timestamp - a.timestamp);
                
            if (patientNotes.length === 0) {
                this.notesList.innerHTML = '<li class="no-notes-message">Nenhuma sessão salva.</li>';
                return;
            }
            
            patientNotes.forEach(note => {
                const li = document.createElement('li');
                li.className = 'note-item';
                if (this.currentNote && note.id === this.currentNote.id) {
                    li.classList.add('active');
                }
                li.setAttribute('data-note-id', note.id);
                
                let displayTitle = note.title.trim();
                const placeholderTitle = this.editorTitle.getAttribute('placeholder') || 'Sessão Sem Título';
                
                if (!displayTitle || displayTitle === placeholderTitle) {
                    const firstLine = (note.polishedNote || note.rawTranscription)
                        .split('\n')
                        .find(line => line.trim().length > 0)
                        ?.replace(/^[#*-\s>]+/, '')
                        .trim();
                        
                    displayTitle = firstLine ?
                        firstLine.substring(0, 40) + (firstLine.length > 40 ? '...' : '') :
                        'Nova Sessão';
                }
                
                const date = new Date(note.timestamp).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                });
                
                li.innerHTML = `
                    <div class="note-item-title">${displayTitle}</div>
                    <div class="note-item-date">${date}</div>
                    <button class="delete-note-button" title="Apagar Sessão"><i class="fas fa-trash"></i></button>
                `;
                this.notesList.appendChild(li);
            });
        }

        saveCurrentNote() {
            if (!this.currentNote || !this.currentPatient) return;
            const noteIndex = this.notes.findIndex(n => n.id === this.currentNote.id);
            if (noteIndex === -1) return;
            
            this.currentNote.title = this.editorTitle.textContent || '';
            this.currentNote.rawTranscription = this.rawTranscription.textContent || '';
            this.currentNote.polishedNote = this.polishedNote.innerHTML || '';
            this.currentNote.timestamp = Date.now();
            this.notes[noteIndex] = this.currentNote;
            this.saveNotesToStorage();
            this.renderNotesList();
        }

        loadNote(noteId) {
            const note = this.notes.find(n => n.id === noteId);
            if (!note) return;
            
            this.currentNote = note;
            this.editorTitle.textContent = note.title;
            this.rawTranscription.textContent = note.rawTranscription;
            this.polishedNote.innerHTML = note.polishedNote;
            
            // Atualizar placeholders
            [this.editorTitle, this.rawTranscription, this.polishedNote].forEach(el => {
                const placeholder = el.getAttribute('placeholder') || '';
                const content = el.id === 'polishedNote' ? el.innerHTML : el.textContent;
                if (!content || content.trim() === '' || content === placeholder) {
                    el.classList.add('placeholder-active');
                    if (el.id === 'polishedNote') {
                        el.innerHTML = placeholder;
                    } else {
                        el.textContent = placeholder;
                    }
                } else {
                    el.classList.remove('placeholder-active');
                }
            });
            
            this.renderNotesList();
        }

        deleteNote(noteId) {
            const noteIndex = this.notes.findIndex(n => n.id === noteId);
            if (noteIndex === -1 || !this.currentPatient) return;
            
            const message = "Tem certeza que deseja apagar esta sessão? Esta ação não pode ser desfeita.";
            this.showConfirmationModal(message, () => {
                this.notes.splice(noteIndex, 1);
                this.saveNotesToStorage();
                
                if (this.currentNote && this.currentNote.id === noteId) {
                    const patientNotes = this.notes
                        .filter(n => n.patientId === this.currentPatient.id)
                        .sort((a, b) => b.timestamp - a.timestamp);
                        
                    if (patientNotes.length > 0) {
                        this.loadNote(patientNotes[0].id);
                    } else {
                        this.createNewNote();
                    }
                } else {
                    this.renderNotesList();
                }
            });
        }

        handleResize() {
            if (this.isRecording && this.liveWaveformCanvas && this.liveWaveformCanvas.style.display === 'block') {
                requestAnimationFrame(() => {
                    this.setupCanvasDimensions();
                });
            }
        }

        initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                this.themeToggleButton.querySelector('i').className = 'fas fa-moon';
            } else {
                document.body.classList.remove('light-mode');
                this.themeToggleButton.querySelector('i').className = 'fas fa-sun';
            }
        }

        toggleTheme() {
            document.body.classList.toggle('light-mode');
            if (document.body.classList.contains('light-mode')) {
                localStorage.setItem('theme', 'light');
                this.themeToggleButton.querySelector('i').className = 'fas fa-moon';
            } else {
                localStorage.setItem('theme', 'dark');
                this.themeToggleButton.querySelector('i').className = 'fas fa-sun';
            }
        }

        async toggleRecording() {
            if (!this.currentPatient) {
                alert("Por favor, selecione um paciente antes de iniciar a gravação.");
                return;
            }

            const webhookUrl = localStorage.getItem('N8N_WEBHOOK_URL');
            if (!webhookUrl) {
                this.showSettingsModal(true, 'Você precisa configurar a URL do webhook do n8n para processar as gravações.');
                return;
            }

            if (!this.isRecording) {
                await this.startRecording();
            } else {
                await this.stopRecording();
            }
        }

        setupAudioVisualizer() {
            if (!this.stream || this.audioContext) return;
            
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = this.audioContext.createMediaStreamSource(this.stream);
            this.analyserNode = this.audioContext.createAnalyser();
            this.analyserNode.fftSize = 256;
            this.analyserNode.smoothingTimeConstant = 0.75;
            const bufferLength = this.analyserNode.frequencyBinCount;
            this.waveformDataArray = new Uint8Array(bufferLength);
            source.connect(this.analyserNode);
        }

        drawLiveWaveform() {
            if (!this.analyserNode || !this.waveformDataArray || !this.liveWaveformCtx || !this.liveWaveformCanvas || !this.isRecording) {
                if (this.waveformDrawingId) cancelAnimationFrame(this.waveformDrawingId);
                this.waveformDrawingId = null;
                return;
            }
            
            this.waveformDrawingId = requestAnimationFrame(() => this.drawLiveWaveform());
            this.analyserNode.getByteFrequencyData(this.waveformDataArray);
            
            const ctx = this.liveWaveformCtx;
            const canvas = this.liveWaveformCanvas;
            const logicalWidth = canvas.clientWidth;
            const logicalHeight = canvas.clientHeight;
            
            ctx.clearRect(0, 0, logicalWidth, logicalHeight);
            
            const bufferLength = this.analyserNode.frequencyBinCount;
            const numBars = Math.floor(bufferLength * 0.5);
            if (numBars === 0) return;
            
            const totalBarPlusSpacingWidth = logicalWidth / numBars;
            const barWidth = Math.max(1, Math.floor(totalBarPlusSpacingWidth * 0.7));
            const barSpacing = Math.max(0, Math.floor(totalBarPlusSpacingWidth * 0.3));
            let x = 0;
            
            const recordingColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--color-recording')
                .trim() || '#ff3b30';
            
            ctx.fillStyle = recordingColor;
            
            for (let i = 0; i < numBars; i++) {
                if (x >= logicalWidth) break;
                const dataIndex = Math.floor(i * (bufferLength / numBars));
                const barHeightNormalized = this.waveformDataArray[dataIndex] / 255.0;
                let barHeight = barHeightNormalized * logicalHeight;
                if (barHeight < 1 && barHeight > 0) barHeight = 1;
                barHeight = Math.round(barHeight);
                const y = Math.round((logicalHeight - barHeight) / 2);
                ctx.fillRect(Math.floor(x), y, barWidth, barHeight);
                x += barWidth + barSpacing;
            }
        }

        updateLiveTimer() {
            if (!this.isRecording || !this.liveRecordingTimerDisplay) return;
            const now = Date.now();
            const elapsedMs = now - this.recordingStartTime;
            const totalSeconds = Math.floor(elapsedMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const hundredths = Math.floor((elapsedMs % 1000) / 10);
            
            this.liveRecordingTimerDisplay.textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(hundredths).padStart(2, '0')}`;
        }

        startLiveDisplay() {
            if (!this.recordingInterface || !this.liveRecordingTitle || !this.liveWaveformCanvas || !this.liveRecordingTimerDisplay) {
                console.warn('One or more live display elements are missing. Cannot start live display.');
                return;
            }
            
            // Encontrar elemento recordingInterface
            const recordingInterface = document.querySelector('.recording-interface');
            if (recordingInterface) {
                recordingInterface.classList.add('is-live');
            }
            
            this.liveRecordingTitle.style.display = 'block';
            this.liveWaveformCanvas.style.display = 'block';
            this.liveRecordingTimerDisplay.style.display = 'block';
            this.setupCanvasDimensions();
            
            if (this.statusIndicatorDiv) this.statusIndicatorDiv.style.display = 'none';
            
            const iconElement = this.recordButton.querySelector('.record-button-inner i');
            if (iconElement) {
                iconElement.classList.remove('fa-microphone');
                iconElement.classList.add('fa-stop');
            }
            
            const currentTitle = this.editorTitle.textContent?.trim();
            const placeholder = this.editorTitle.getAttribute('placeholder') || 'Sessão Sem Título';
            this.liveRecordingTitle.textContent = 
                (currentTitle && currentTitle !== placeholder) ? currentTitle : 'Nova Gravação';
            
            this.setupAudioVisualizer();
            this.drawLiveWaveform();
            this.recordingStartTime = Date.now();
            this.updateLiveTimer();
            
            if (this.timerIntervalId) clearInterval(this.timerIntervalId);
            this.timerIntervalId = setInterval(() => this.updateLiveTimer(), 50);
        }

        stopLiveDisplay() {
            const recordingInterface = document.querySelector('.recording-interface');
            if (recordingInterface) {
                recordingInterface.classList.remove('is-live');
            }
            
            this.liveRecordingTitle.style.display = 'none';
            this.liveWaveformCanvas.style.display = 'none';
            this.liveRecordingTimerDisplay.style.display = 'none';
            
            if (this.statusIndicatorDiv) this.statusIndicatorDiv.style.display = 'block';
            
            const iconElement = this.recordButton.querySelector('.record-button-inner i');
            if (iconElement) {
                iconElement.classList.remove('fa-stop');
                iconElement.classList.add('fa-microphone');
            }
            
            if (this.waveformDrawingId) {
                cancelAnimationFrame(this.waveformDrawingId);
                this.waveformDrawingId = null;
            }
            
            if (this.timerIntervalId) {
                clearInterval(this.timerIntervalId);
                this.timerIntervalId = null;
            }
            
            if (this.liveWaveformCtx && this.liveWaveformCanvas) {
                this.liveWaveformCtx.clearRect(0, 0, this.liveWaveformCanvas.width, this.liveWaveformCanvas.height);
            }
            
            if (this.audioContext) {
                if (this.audioContext.state !== 'closed') {
                    this.audioContext.close().catch(e => console.warn('Error closing audio context', e));
                }
                this.audioContext = null;
            }
            
            this.analyserNode = null;
            this.waveformDataArray = null;
        }

        async startRecording() {
            try {
                this.audioChunks = [];
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    await this.audioContext.close();
                    this.audioContext = null;
                }
                
                this.recordingStatus.textContent = 'Solicitando acesso ao microfone...';
                
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (err) {
                    console.error('Failed with basic constraints:', err);
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                        },
                    });
                }
                
                try {
                    this.mediaRecorder = new MediaRecorder(this.stream, {
                        mimeType: 'audio/webm',
                    });
                } catch (e) {
                    console.error('audio/webm not supported, trying default:', e);
                    this.mediaRecorder = new MediaRecorder(this.stream);
                }
                
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        this.audioChunks.push(event.data);
                    }
                };
                
                this.mediaRecorder.onstop = () => {
                    this.stopLiveDisplay();
                    if (this.audioChunks.length > 0) {
                        const audioBlob = new Blob(this.audioChunks, {
                            type: this.mediaRecorder?.mimeType || 'audio/webm',
                        });
                        this.processAudio(audioBlob).catch(err => {
                            console.error('Error processing audio:', err);
                            this.recordingStatus.textContent = 'Erro ao processar a gravação';
                        });
                    } else {
                        this.recordingStatus.textContent = 'Nenhum dado de áudio capturado. Tente novamente.';
                    }
                    
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        this.stream = null;
                    }
                };
                
                this.mediaRecorder.start();
                this.isRecording = true;
                this.recordButton.classList.add('recording');
                this.recordButton.setAttribute('title', 'Parar Gravação');
                this.startLiveDisplay();
            } catch (error) {
                console.error('Error starting recording:', error);
                const errorMessage = error instanceof Error ? error.message : String(error);
                const errorName = error instanceof Error ? error.name : 'Unknown';
                
                if (errorName === 'NotAllowedError' || errorName === 'PermissionDeniedError') {
                    this.recordingStatus.textContent = 'Permissão do microfone negada. Verifique as configurações do seu navegador e recarregue a página.';
                } else if (errorName === 'NotFoundError' || 
                          (errorName === 'DOMException' && errorMessage.includes('Requested device not found'))) {
                    this.recordingStatus.textContent = 'Nenhum microfone encontrado. Por favor, conecte um microfone.';
                } else if (errorName === 'NotReadableError' || 
                          errorName === 'AbortError' || 
                          (errorName === 'DOMException' && errorMessage.includes('Failed to allocate audiosource'))) {
                    this.recordingStatus.textContent = 'Não é possível acessar o microfone. Ele pode estar em uso por outro aplicativo.';
                } else {
                    this.recordingStatus.textContent = `Erro: ${errorMessage}`;
                }
                
                this.isRecording = false;
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.recordButton.classList.remove('recording');
                this.recordButton.setAttribute('title', 'Iniciar Gravação');
                this.stopLiveDisplay();
            }
        }

        async stopRecording() {
            if (this.mediaRecorder && this.isRecording) {
                try {
                    this.mediaRecorder.stop();
                } catch (e) {
                    console.error('Error stopping MediaRecorder:', e);
                    this.stopLiveDisplay();
                }
                this.isRecording = false;
                this.recordButton.classList.remove('recording');
                this.recordButton.setAttribute('title', 'Iniciar Gravação');
                this.recordingStatus.textContent = 'Processando áudio...';
            } else {
                if (!this.isRecording) this.stopLiveDisplay();
            }
        }

        async processAudio(audioBlob) {
            if (audioBlob.size === 0) {
                this.recordingStatus.textContent = 'Nenhum dado de áudio capturado. Tente novamente.';
                return;
            }
            
            try {
                this.recordingStatus.textContent = 'Enviando áudio para processamento...';
                const result = await this.n8nService.processSession(audioBlob);
                
                // Atualizar UI com resultados
                this.rawTranscription.textContent = result.transcription;
                if (result.transcription.trim() !== '') {
                    this.rawTranscription.classList.remove('placeholder-active');
                } else {
                    const placeholder = this.rawTranscription.getAttribute('placeholder') || '';
                    this.rawTranscription.textContent = placeholder;
                    this.rawTranscription.classList.add('placeholder-active');
                }
                
                if (this.currentNote) {
                    this.currentNote.rawTranscription = result.transcription;
                }
                
                // Formatar registro com markdown
                const htmlContent = marked.parse(result.polishedNote);
                this.polishedNote.innerHTML = htmlContent;
                if (result.polishedNote.trim() !== '') {
                    this.polishedNote.classList.remove('placeholder-active');
                } else {
                    const placeholder = this.polishedNote.getAttribute('placeholder') || '';
                    this.polishedNote.innerHTML = placeholder;
                    this.polishedNote.classList.add('placeholder-active');
                }
                
                // Atualizar título
                let noteTitleSet = false;
                const lines = result.polishedNote.split('\n').map(l => l.trim());
                for (const line of lines) {
                    if (line.startsWith('#')) {
                        const title = line.replace(/^#+\s+/, '').trim();
                        if (this.editorTitle && title) {
                            this.editorTitle.textContent = title;
                            this.editorTitle.classList.remove('placeholder-active');
                            noteTitleSet = true;
                            break;
                        }
                    }
                }
                
                // Salvar nota atual
                if (this.currentNote) {
                    this.currentNote.polishedNote = this.polishedNote.innerHTML;
                    this.currentNote.title = this.editorTitle.textContent || '';
                    this.saveCurrentNote();
                }
                
                this.recordingStatus.textContent = 'Processamento concluído. Registro formatado.';
            } catch (error) {
                console.error('Error in processAudio:', error);
                this.recordingStatus.textContent = 'Erro ao processar a gravação. Tente novamente.';
                this.polishedNote.innerHTML = `<p><em>Erro durante o processamento: ${error instanceof Error ? error.message : String(error)}</em></p>`;
                this.rawTranscription.textContent = this.rawTranscription.getAttribute('placeholder');
                this.rawTranscription.classList.add('placeholder-active');
            }
        }

        createNewNote() {
            if (!this.currentPatient) return;
            
            if (this.isRecording) {
                this.mediaRecorder?.stop();
                this.isRecording = false;
                this.recordButton.classList.remove('recording');
            } else {
                this.stopLiveDisplay();
            }
            
            const placeholderTitle = this.editorTitle.getAttribute('placeholder') || 'Sessão Sem Título';
            const newNote = {
                id: `note_${Date.now()}`,
                patientId: this.currentPatient.id,
                title: placeholderTitle,
                rawTranscription: '',
                polishedNote: '',
                timestamp: Date.now(),
            };
            
            this.notes.unshift(newNote);
            this.saveNotesToStorage();
            this.loadNote(newNote.id);
            this.recordingStatus.textContent = 'Pronto para gravar';
        }

        setupCanvasDimensions() {
            if (!this.liveWaveformCanvas || !this.liveWaveformCtx) return;
            
            const canvas = this.liveWaveformCanvas;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            const cssWidth = rect.width;
            const cssHeight = rect.height;
            
            canvas.width = Math.round(cssWidth * dpr);
            canvas.height = Math.round(cssHeight * dpr);
            this.liveWaveformCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
    }

    // Funções auxiliares para conteúdo editável
    document.querySelectorAll('[contenteditable][placeholder]').forEach(el => {
        const placeholder = el.getAttribute('placeholder');
        
        function updatePlaceholderState() {
            const currentText = el.id === 'polishedNote' ? el.innerText : el.textContent;
            if (currentText === '' || currentText === placeholder) {
                if (el.id === 'polishedNote' && currentText === '') {
                    el.innerHTML = placeholder;
                } else if (currentText === '') {
                    el.textContent = placeholder;
                }
                el.classList.add('placeholder-active');
            } else {
                el.classList.remove('placeholder-active');
            }
        }
        
        updatePlaceholderState();
        
        el.addEventListener('focus', function() {
            const currentText = this.id === 'polishedNote' ? this.innerText : this.textContent;
            if (currentText === placeholder) {
                if (this.id === 'polishedNote') this.innerHTML = '';
                else this.textContent = '';
                this.classList.remove('placeholder-active');
            }
        });
        
        el.addEventListener('blur', function() {
            updatePlaceholderState();
        });
    });

    // Inicializar aplicativo
    new VoiceNotesApp();
});
